<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>海上的日子 — MVP</title>
<style>
  :root{
    --paper:#f5f0e6;
    --brown:#8B4513;
    --mist:#A7C4D9;
    --font-family: "Ma Shan Zheng Shu", "KaiTi", "cursive", serif;
  }
  body{
    background: var(--paper);
    color: var(--brown);
    font-family: var(--font-family);
    line-height: 1.8;
    padding: 20px;
  }
  .container{
    display:flex;
    gap:20px;
    align-items:flex-start;
  }
  .map {
    position:relative;
    width:800px;
    height:600px;
    background-image: url('placeholder_map_800x600.png');
    background-size:cover;
    box-shadow: 0 8px 24px rgba(139,69,19,0.08);
    border-radius:8px;
  }
  svg{ position:absolute; left:0; top:0; width:800px; height:600px; pointer-events:none; }
  .route { stroke:var(--brown); stroke-width:2; fill:none; stroke-dasharray:10 10; opacity:0.75; pointer-events:all; cursor:pointer; filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
  @keyframes dash { to { stroke-dashoffset: -1000; } }
  .route { animation: dash 8s linear infinite; }
  .route:hover { filter: drop-shadow(0 0 8px rgba(167,196,217,0.45)); opacity:1; stroke-width:2.5; }
  .xmark{
    position:absolute;
    font-size:26px;
    color:var(--brown);
    transform:translate(-50%,-50%);
    animation: breathe 2.8s ease-in-out infinite;
    text-shadow: 0 0 6px rgba(167,196,217,0.25);
  }
  @keyframes breathe { 0%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.06);}100%{transform:translate(-50%,-50%) scale(1);} }
  .compass {
    position:absolute; right:12px; bottom:12px; width:84px; height:84px;
    border-radius:50%; background:transparent; display:flex; align-items:center; justify-content:center;
    font-weight:bold; color:var(--brown); transform-origin:center; animation: spin 60s linear infinite;
  }
  @keyframes spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
  .panel { width:360px; padding:16px; border-radius:8px; background:rgba(255,255,255,0.5); box-shadow: inset 0 0 0 1px rgba(139,69,19,0.04); }
  .log { white-space:pre-wrap; font-size:16px; margin-top:10px; }
  .btn { background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  .small { font-size:14px; color:#666; }
  .route-label { position:absolute; background:rgba(255,255,255,0.6); padding:6px 8px; border-radius:6px; font-size:14px; left:16px; top:8px; color:var(--brown); }
</style>
</head>
<body>
  <h1>海上的日子</h1>
  <p class="small">MVP：点击航线 → 生成一篇中英双语航海日志（含可直接用于文生图的 prompt）</p>

  <div class="container">
    <div class="map" id="map">
      <!-- 你要准备一张本地静态占位图 placeholder_map_800x600.png -->
      <svg viewBox="0 0 800 600" preserveAspectRatio="xMinYMin meet">
        <!-- 三条示意贝塞尔曲线，pointer-events 由 CSS 打开 -->
        <path id="route_r1" class="route" d="M60,500 Q280,380 700,120" data-route="r1"></path>
        <path id="route_r2" class="route" d="M40,140 Q320,80 680,180" data-route="r2"></path>
        <path id="route_r3" class="route" d="M120,420 Q360,300 630,430" data-route="r3"></path>
      </svg>

      <!-- X 标记（示例绝对坐标）-->
      <div class="xmark" style="left:680px; top:180px;">✕</div>
      <div class="xmark" style="left:630px; top:430px;">✕</div>

      <div class="compass">N</div>
      <div class="route-label">点击任意航线以生成日志</div>
    </div>

    <div class="panel">
      <div>
        <label>语言：</label>
        <select id="langToggle">
          <option value="both">中 / EN（同时显示）</option>
          <option value="cn">仅中文</option>
          <option value="en">仅英文</option>
        </select>
        <button id="downloadBtn" class="btn" style="float:right">下载 txt</button>
      </div>

      <div id="logCard" class="log" style="margin-top:14px;">
        点击地图上的航线开始航程……
      </div>

      <div style="margin-top:10px;" class="small">
        <div>提示词（用于图像生成）：</div>
        <pre id="imagePrompt" style="white-space:pre-wrap;margin-top:6px;"></pre>
      </div>

    </div>
  </div>

<script>
const logCard = document.getElementById('logCard');
const imagePrompt = document.getElementById('imagePrompt');
const langToggle = document.getElementById('langToggle');
const downloadBtn = document.getElementById('downloadBtn');

async function fetchLog(routeId){
  try{
    const res = await fetch(`/generate_log?route_id=${routeId}`);
    if(!res.ok) throw new Error('生成失败');
    const data = await res.json();
    renderLog(data);
    saveRecent(data);
  } catch(e){
    logCard.textContent = '无法生成日志：' + e.message;
  }
}

function renderLog(data){
  const lang = langToggle.value;
  let text = '';
  if(lang === 'both' || lang === 'cn'){
    text += `${data.route_name}\n${data.day_cn}\n位置：${data.position_cn}\n事件：${data.event_cn}\n感悟：${data.feeling_cn}\n\n`;
  }
  if(lang === 'both' || lang === 'en'){
    text += `${data.route_name} — ${data.day_en}\nPosition: ${data.position_en}\nEvent: ${data.event_en}\nFeeling: ${data.feeling_en}\n`;
  }
  logCard.textContent = text;
  imagePrompt.textContent = data.image_prompt_en;
}

function saveRecent(data){
  let rec = JSON.parse(localStorage.getItem('recent_logs')||'[]');
  rec.unshift({t:new Date().toISOString(), d:data});
  if(rec.length>10) rec = rec.slice(0,10);
  localStorage.setItem('recent_logs', JSON.stringify(rec));
}

downloadBtn.addEventListener('click', ()=>{
  const text = logCard.textContent || "no log";
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const now = new Date().toISOString().slice(0,19).replace('T','_');
  a.download = `seaday_${now}.txt`;
  a.click();
});

document.querySelectorAll('.route').forEach(el=>{
  el.addEventListener('click', (ev)=>{
    const routeId = el.getAttribute('data-route');
    fetchLog(routeId);
  });
  // 允许 hover 显示诗意名（简单）
  el.addEventListener('mouseenter', ()=>{
    const id = el.getAttribute('data-route');
    const titles = {r1:'去鲸骨岛的路', r2:'风暴眼后的秘境', r3:'无名弯的逸梦'};
    const label = document.querySelector('.route-label');
    label.textContent = titles[id] || '航线';
  });
  el.addEventListener('mouseleave', ()=>{
    const label = document.querySelector('.route-label');
    label.textContent = '点击任意航线以生成日志';
  });
});
</script>
</body>
</html>
